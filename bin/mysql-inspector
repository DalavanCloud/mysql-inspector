#!/usr/bin/env ruby

require 'optparse'
require "lib/mysql-inspector"

options = {
  :compare => false,
  :dumps => [],
  :base_dir => ".",
  :clean => true,
  :dump => true
}

OptionParser.new do |opts|
  opts.banner = "Usage: ????"

  opts.on("-c", "--compare db1,db2") do |compare|

    if compare =~ /,/
      current, target = compare.split ","
      db_current, version_name_current = current.split(":")
      db_target, version_name_target = target.split(":")
    else
      db_current, db_target = "#{compare}_development", "#{compare}_test"
    end

    options[:compare] = true
    options[:dumps] << [db_current, version_name_current || "current"]
    options[:dumps] << [db_target, version_name_target || "target"]
  end
end.parse!

if options[:compare]
  current, target = options[:dumps].collect do |db, version|
    MysqlInspector::Dump.new(db,version, options[:base_dir])
  end

  if options[:clean]
    [current, target].each { |d| d.clean! }
  end
  if options[:dump]
    [current, target].each { |d| d.run! }
  end

  comparison = MysqlInspector::Comparison.new(current, target)
  comparison.compare(STDOUT)
else
  puts "nothing to do"
end
